# Prometheus Configuration for Hubra Vaults
# Uses Docker service discovery to auto-detect rebalancer containers

global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Docker service discovery for rebalancers
  # Auto-discovers containers with label: hubra.rebalancer=true
  - job_name: 'hubra-rebalancers'
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        filters:
          - name: label
            values: ['hubra.rebalancer=true']
    
    relabel_configs:
      # Use container name as instance label
      - source_labels: [__meta_docker_container_name]
        regex: '/(.*)'
        target_label: instance
      
      # Extract vault symbol from label
      - source_labels: [__meta_docker_container_label_hubra_vault_symbol]
        target_label: vault_symbol
      
      # Extract vault address from label
      - source_labels: [__meta_docker_container_label_hubra_vault_address]
        target_label: vault_address
      
      # Set the metrics path
      - source_labels: []
        target_label: __metrics_path__
        replacement: /metrics
      
      # Use internal Docker network port (9090)
      - source_labels: [__meta_docker_network_ip]
        regex: '(.*)'
        target_label: __address__
        replacement: '${1}:9090'

  # Monitor service (if it exposes metrics)
  - job_name: 'hubra-monitor'
    static_configs:
      - targets: ['hubra-monitor:9090']
    # Only scrape if metrics endpoint exists
    scrape_timeout: 5s
